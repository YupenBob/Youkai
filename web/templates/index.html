<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>YOUKAI — Kali 风格控制台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      .zzz-bg { background: linear-gradient(180deg, #0a0a0f 0%, #0d0d14 50%, #0a0a0f 100%); }
      .term-cmd { color: #e879f9; }
      .term-info { color: #94a3b8; }
      .term-success { color: #34d399; }
      .term-warn { color: #fbbf24; }
      .term-error { color: #f87171; }
      .term-thinking { color: #a78bfa; font-style: italic; }
      #panel-report-content { line-height: 1.5; }
      #panel-report-content pre { white-space: pre-wrap; background: rgba(0,0,0,0.3); padding: 6px; border-radius: 4px; }
      #panel-report-content code { background: rgba(0,0,0,0.3); padding: 0 4px; border-radius: 2px; }
      #panel-report-content ul, #panel-report-content ol { margin: 0.5em 0; padding-left: 1.5em; }
      .youkai-logo { filter: drop-shadow(0 0 12px rgba(232,121,249,0.5)); }
      /* Kali 窗口 */
      .kali-window {
        position: absolute;
        min-width: 200px;
        min-height: 120px;
        background: #1e1e2e;
        border: 1px solid #45475a;
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.5);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .kali-window-title {
        height: 28px;
        background: #313244;
        border-bottom: 1px solid #45475a;
        display: flex;
        align-items: center;
        padding-left: 8px;
        gap: 6px;
        cursor: move;
        user-select: none;
      }
      .kali-window-title .btn { width: 12px; height: 12px; border-radius: 50%; }
      .kali-window-title .btn-close { background: #f38ba8; }
      .kali-window-title .btn-min { background: #f9e2af; }
      .kali-window-title .btn-max { background: #a6e3a1; }
      .kali-window-title .name { margin-left: 6px; font-size: 11px; color: #cdd6f4; }
      .kali-window-body { flex: 1; overflow: auto; padding: 8px; font-size: 11px; font-family: monospace; color: #a6adc8; }
      .kali-window-body pre { margin: 0; white-space: pre-wrap; word-break: break-all; }
      .kali-window-resize {
        position: absolute;
        right: 0;
        bottom: 0;
        width: 16px;
        height: 16px;
        cursor: nwse-resize;
        background: linear-gradient(135deg, transparent 50%, #45475a 50%);
      }
    </style>
  </head>
  <body class="zzz-bg min-h-screen text-slate-100 font-sans antialiased">
    <div class="min-h-screen flex flex-col">
      <header class="border-b border-slate-800 flex-shrink-0" style="background: rgba(10,10,15,0.95);">
        <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="youkai-logo">
              <svg width="36" height="36" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="28" fill="url(#mg)" opacity="0.9"/><circle cx="32" cy="32" r="12" fill="rgba(255,255,255,0.9)"/><defs><linearGradient id="mg" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#e879f9"/><stop offset="1" stop-color="#d946ef"/></linearGradient></defs></svg>
            </div>
            <span class="font-bold text-white">YOUKAI</span>
          </div>
          <a href="/settings" class="text-xs text-slate-400 hover:text-fuchsia-400 px-2 py-1 rounded border border-slate-600">设置</a>
        </div>
      </header>

      {% if need_settings %}
      <div class="max-w-7xl mx-auto w-full px-4 py-2">
        <div class="rounded border border-amber-500/40 bg-amber-500/10 px-3 py-2 text-sm text-amber-200 flex justify-between items-center">
          <span>请先在「设置」中配置 LLM API Key</span>
          <a href="/settings" class="text-amber-300 font-medium">去设置</a>
        </div>
      </div>
      {% endif %}

      <!-- 桌面：可拖动、可调整大小的 Kali 窗口 -->
      <div id="desktop" class="flex-1 relative overflow-hidden" style="min-height: 400px;">
        <div class="kali-window" id="win-local" style="left: 12px; top: 12px; width: 260px; height: 160px;" data-window="local">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">本机性能</span></div>
          <div class="kali-window-body"><pre id="panel-local-content">— 下达指令后刷新 —</pre></div>
          <div class="kali-window-resize" title="拖动调整大小"></div>
        </div>
        <div class="kali-window" id="win-target" style="left: 284px; top: 12px; width: 260px; height: 160px;" data-window="target">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">目标情况</span></div>
          <div class="kali-window-body"><pre id="panel-target-content">— 下达指令后刷新 —</pre></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window" id="win-ports" style="left: 556px; top: 12px; width: 260px; height: 160px;" data-window="ports">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">目标端口</span></div>
          <div class="kali-window-body"><pre id="panel-ports-content">— 下达指令后刷新 —</pre></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window" id="win-tracking" style="left: 12px; top: 184px; width: 260px; height: 140px;" data-window="tracking">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">实施跟踪</span></div>
          <div class="kali-window-body"><pre id="panel-tracking-content">— 下达指令后刷新 —</pre></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window" id="win-report" style="left: 284px; top: 184px; width: 532px; height: 200px;" data-window="report">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">Youkai 报告 (支持 Markdown)</span></div>
          <div class="kali-window-body"><div id="panel-report-content">— 下达指令后刷新 —</div></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window" id="win-terminal" style="left: 12px; top: 336px; width: 600px; height: 220px;" data-window="terminal">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">TERMINAL — Kali 输出</span></div>
          <div class="kali-window-body p-2 overflow-auto bg-black/50 min-h-0 flex-1"><pre id="terminal-output" class="m-0"><span class="term-info">等待指令… 例如：扫描 192.168.1.1</span></pre></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window" id="win-tools" style="left: 624px; top: 12px; width: 320px; height: 380px;" data-window="tools">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">Kali 工具</span></div>
          <div class="kali-window-body overflow-auto" id="tools-list">
            <p class="text-slate-500 text-xs mb-2">加载中…</p>
          </div>
          <div class="kali-window-resize"></div>
        </div>
      </div>

      <footer class="flex-shrink-0 border-t border-slate-800 px-4 py-2" style="background: rgba(10,10,15,0.95);">
        <form id="command-form" class="flex gap-2 items-center">
          <input type="text" id="command-input" placeholder="与 Youkai 对话：扫描 192.168.1.1 …" class="flex-1 rounded border border-slate-600 bg-slate-900/80 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-fuchsia-500 focus:outline-none" autocomplete="off" />
          <button type="submit" id="command-submit" class="rounded bg-fuchsia-600 hover:bg-fuchsia-500 px-4 py-2 text-sm font-medium text-white">发送</button>
        </form>
        <div class="mt-2 flex flex-wrap gap-3 items-center text-xs text-slate-500">
          <span>利用：</span>
          <input type="text" id="exploit-url" placeholder="http://target/page?id=1" class="rounded border border-slate-600 bg-slate-900/80 px-2 py-1 text-white w-48" />
          <button type="button" id="exploit-sqlmap" class="rounded border border-red-500/50 bg-red-500/20 text-red-300 px-2 py-1">SQL 注入 (sqlmap)</button>
        </div>
      </footer>
    </div>

    <script>
      (function() {
        var desktop = document.getElementById('desktop');
        var zIndex = 10;

        function bringFront(win) {
          win.style.zIndex = ++zIndex;
        }

        function makeDraggable(win) {
          var title = win.querySelector('.kali-window-title');
          if (!title) return;
          title.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('btn')) return;
            bringFront(win);
            var dx = e.clientX - win.offsetLeft;
            var dy = e.clientY - win.offsetTop;
            function move(e2) {
              var l = e2.clientX - dx;
              var t = e2.clientY - dy;
              var r = desktop.getBoundingClientRect();
              win.style.left = Math.max(0, Math.min(l, r.width - 50)) + 'px';
              win.style.top = Math.max(0, Math.min(t, r.height - 40)) + 'px';
            }
            function stop() {
              document.removeEventListener('mousemove', move);
              document.removeEventListener('mouseup', stop);
            }
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', stop);
          });
        }

        function makeResizable(win) {
          var resize = win.querySelector('.kali-window-resize');
          if (!resize) return;
          resize.addEventListener('mousedown', function(e) {
            e.preventDefault();
            bringFront(win);
            var startW = win.offsetWidth;
            var startH = win.offsetHeight;
            var startX = e.clientX;
            var startY = e.clientY;
            function resizeMove(e2) {
              var dw = e2.clientX - startX;
              var dh = e2.clientY - startY;
              win.style.width = Math.max(200, startW + dw) + 'px';
              win.style.height = Math.max(100, startH + dh) + 'px';
            }
            function stop() {
              document.removeEventListener('mousemove', resizeMove);
              document.removeEventListener('mouseup', stop);
            }
            document.addEventListener('mousemove', resizeMove);
            document.addEventListener('mouseup', stop);
          });
        }

        desktop.querySelectorAll('.kali-window').forEach(function(win) {
          makeDraggable(win);
          makeResizable(win);
        });
      })();

      var form = document.getElementById('command-form');
      var input = document.getElementById('command-input');
      var submitBtn = document.getElementById('command-submit');
      var terminal = document.getElementById('terminal-output');

      function appendTerminal(lines) {
        var frag = document.createDocumentFragment();
        lines.forEach(function(line) {
          var span = document.createElement('span');
          span.className = 'term-' + (line.type || 'info');
          span.textContent = line.text + '\n';
          frag.appendChild(span);
        });
        terminal.appendChild(frag);
        terminal.scrollTop = terminal.scrollHeight;
      }

      function setPanel(id, text) {
        var el = document.getElementById('panel-' + id + '-content');
        if (!el) return;
        if (id === 'report' && typeof marked !== 'undefined') {
          try { el.innerHTML = marked.parse(text || '—'); } catch (e) { el.textContent = text || '—'; }
        } else {
          el.textContent = text || '—';
        }
      }

      function setPanels(panels) {
        if (!panels) return;
        var ls = panels.local_stats;
        if (ls) setPanel('local', 'CPU: ' + (ls.cpu_percent ?? 0) + '%\n内存: ' + (ls.mem_percent ?? 0) + '% (' + (ls.mem_used_gb ?? 0) + '/' + (ls.mem_total_gb ?? 0) + ' GB)');
        var ti = panels.target_info;
        if (ti) setPanel('target', 'Goal: ' + (ti.goal || '') + '\nTarget: ' + (ti.target || ''));
        setPanel('ports', panels.ports);
        setPanel('tracking', panels.tracking);
        setPanel('report', panels.report);
      }

      function readStreamNDJSON(res, onLine) {
        var reader = res.body.getReader();
        var decoder = new TextDecoder();
        var buf = '';
        function pump() {
          return reader.read().then(function(chunk) {
            if (chunk.done) return;
            buf += decoder.decode(chunk.value, { stream: true });
            var lines = buf.split('\n');
            buf = lines.pop() || '';
            lines.forEach(function(line) {
              line = line.trim();
              if (!line) return;
              try {
                var data = JSON.parse(line);
                onLine(data);
              } catch (e) {}
            });
            return pump();
          });
        }
        return pump();
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        var msg = (input.value || '').trim();
        if (!msg) return;
        submitBtn.disabled = true;
        terminal.innerHTML = '';
        appendTerminal([{ type: 'cmd', text: '[YOUKAI] ' + msg }]);
        try {
          var res = await fetch('/api/command_stream', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msg }) });
          if (!res.ok) {
            appendTerminal([{ type: 'error', text: res.status + ' ' + (await res.text()) }]);
            submitBtn.disabled = false;
            return;
          }
          await readStreamNDJSON(res, function(data) {
            if (data.type === 'thinking') {
              appendTerminal([{ type: 'thinking', text: '[Thinking] ' + (data.step || '') + ' — ' + (data.message || '') }]);
            } else if (data.type === 'done' && data.ok) {
              if (data.panels) setPanels(data.panels);
              if (data.terminal && data.terminal.length) appendTerminal(data.terminal);
            } else if (data.type === 'error') {
              appendTerminal([{ type: 'error', text: data.message || '错误' }]);
            }
          });
        } catch (err) {
          appendTerminal([{ type: 'error', text: err.message || '网络错误' }]);
        }
        submitBtn.disabled = false;
      });

      document.getElementById('exploit-sqlmap').addEventListener('click', async function() {
        var url = (document.getElementById('exploit-url').value || '').trim();
        if (!url) { appendTerminal([{ type: 'warn', text: '[EXPLOIT] 请先输入目标 URL' }]); return; }
        terminal.innerHTML = '';
        appendTerminal([{ type: 'cmd', text: '[EXPLOIT] sqlmap -u ' + url }]);
        submitBtn.disabled = true;
        try {
          var res = await fetch('/api/execute_exploit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'sqlmap', payload: { url: url } }) });
          var data = await res.json();
          if (data.terminal && data.terminal.length) appendTerminal(data.terminal);
          if (!data.ok) appendTerminal([{ type: 'error', text: data.error || '执行失败' }]);
        } catch (err) {
          appendTerminal([{ type: 'error', text: err.message }]);
        }
        submitBtn.disabled = false;
      });

      // Kali 工具列表与运行
      fetch('/api/tools').then(function(r) { return r.json(); }).then(function(data) {
        var list = document.getElementById('tools-list');
        if (!data.tools || !data.tools.length) { list.innerHTML = '<p class="text-slate-500 text-xs">无工具</p>'; return; }
        list.innerHTML = '';
        data.tools.forEach(function(t) {
          var div = document.createElement('div');
          div.className = 'border border-slate-600 rounded p-2 mb-2';
          div.innerHTML = '<div class="text-fuchsia-400 font-medium text-xs">' + t.name + '</div><div class="text-slate-500 text-[10px] mb-1">' + (t.desc || '') + '</div>';
          var params = (t.params || []);
          var inputs = {};
          params.forEach(function(p) {
            var inp = document.createElement('input');
            inp.placeholder = p.placeholder || p.key;
            inp.className = 'w-full rounded border border-slate-600 bg-slate-800/80 px-1.5 py-0.5 text-xs text-white mb-1';
            inp.dataset.key = p.key;
            inputs[p.key] = inp;
            div.appendChild(inp);
          });
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'mt-1 rounded bg-slate-600 hover:bg-slate-500 text-xs px-2 py-0.5';
          btn.textContent = '运行';
          btn.addEventListener('click', function() {
            var paramsObj = {};
            params.forEach(function(p) { paramsObj[p.key] = (inputs[p.key] && inputs[p.key].value) || ''; });
            terminal.innerHTML = '';
            appendTerminal([{ type: 'cmd', text: '[Kali] ' + t.id + ' ' + JSON.stringify(paramsObj) }]);
            fetch('/api/tool', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tool: t.id, params: paramsObj }) })
              .then(function(r) { return r.json(); })
              .then(function(d) {
                if (d.terminal && d.terminal.length) appendTerminal(d.terminal);
                if (!d.ok) appendTerminal([{ type: 'error', text: d.error || '执行失败' }]);
              })
              .catch(function(err) { appendTerminal([{ type: 'error', text: err.message }]); });
          });
          div.appendChild(btn);
          list.appendChild(div);
        });
      }).catch(function() {
        document.getElementById('tools-list').innerHTML = '<p class="text-slate-500 text-xs">加载工具列表失败</p>';
      });
    </script>
  </body>
</html>
