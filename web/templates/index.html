<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>YOUKAI — Kali 风格控制台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .zzz-bg { background: linear-gradient(180deg, #0a0a0f 0%, #0d0d14 50%, #0a0a0f 100%); position: relative; }
      .term-cmd { color: #e879f9; }
      .term-info { color: #94a3b8; }
      .term-success { color: #34d399; }
      .term-warn { color: #fbbf24; }
      .term-error { color: #f87171; }
      .term-thinking { color: #a78bfa; font-style: italic; }
      #panel-report-content { line-height: 1.5; }
      #panel-report-content pre { white-space: pre-wrap; background: rgba(0,0,0,0.3); padding: 6px; border-radius: 4px; }
      #panel-report-content code { background: rgba(0,0,0,0.3); padding: 0 4px; border-radius: 2px; }
      #panel-report-content ul, #panel-report-content ol { margin: 0.5em 0; padding-left: 1.5em; }
      .youkai-logo { filter: drop-shadow(0 0 12px rgba(232,121,249,0.5)); }
      /* 点阵云背景 */
      #dot-matrix-bg { position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none; }
      #dot-matrix-bg canvas { width: 100%; height: 100%; opacity: 0.35; }
      /* 主内容在背景之上 */
      .main-wrap { position: relative; z-index: 1; min-height: 100vh; display: flex; flex-direction: column; }
      /* 任务列表 + 进度条 */
      .task-strip { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 6px 10px; background: rgba(0,20,0,0.25); border: 1px solid rgba(0,255,100,0.2); border-radius: 6px; }
      .task-step { font-size: 10px; color: #64748b; padding: 2px 6px; border-radius: 4px; transition: all 0.3s ease; }
      .task-step.done { color: #22c55e; }
      .task-step.active { color: #a78bfa; background: rgba(167,139,250,0.2); animation: pulse-step 1.2s ease-in-out infinite; }
      @keyframes pulse-step { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(167,139,250,0.4); } 50% { opacity: 0.9; box-shadow: 0 0 12px 2px rgba(167,139,250,0.3); } }
      .matrix-progress { flex: 1; min-width: 120px; height: 8px; background: rgba(0,0,0,0.5); border: 1px solid rgba(0,255,100,0.3); border-radius: 4px; overflow: hidden; }
      .matrix-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #0f0, #0c6); background-size: 16px 100%; animation: matrix-shine 0.8s linear infinite; transition: width 0.4s ease; }
      @keyframes matrix-shine { 0% { background-position: 0 0; } 100% { background-position: 16px 0; } }
      /* 面板快捷按钮 */
      .panel-launcher { display: flex; gap: 4px; flex-wrap: wrap; }
      .panel-launcher button { font-size: 10px; padding: 2px 8px; border-radius: 4px; border: 1px solid #475569; background: rgba(30,30,46,0.9); color: #94a3b8; cursor: pointer; transition: all 0.2s; }
      .panel-launcher button:hover { border-color: #e879f9; color: #e879f9; }
      .panel-launcher button.has-content { border-color: #22c55e; color: #22c55e; }
      /* 窗口：默认隐藏，需要时弹出 + 动画 */
      .kali-window {
        position: absolute;
        min-width: 200px;
        min-height: 120px;
        background: #1e1e2e;
        border: 1px solid #45475a;
        border-radius: 8px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.5);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transform: scale(0.96);
        transition: opacity 0.25s ease, transform 0.25s ease, visibility 0.25s, box-shadow 0.3s ease;
      }
      .kali-window:not(.kali-window--hidden) {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transform: scale(1);
        animation: window-pop 0.3s ease;
      }
      @keyframes window-pop { 0% { opacity: 0; transform: scale(0.96); } 70% { transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
      .kali-window-title {
        height: 28px;
        background: #313244;
        border-bottom: 1px solid #45475a;
        display: flex;
        align-items: center;
        padding-left: 8px;
        gap: 6px;
        cursor: move;
        user-select: none;
      }
      .kali-window-title .name { margin-left: 6px; margin-right: auto; font-size: 11px; color: #cdd6f4; }
      .kali-window-title .btn { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; flex-shrink: 0; }
      .kali-window-title .btn-close { background: #f38ba8; }
      .kali-window-title .btn-min { background: #f9e2af; }
      .kali-window-title .btn-max { background: #a6e3a1; }
      .kali-window-body .btn-exec { padding: 8px 16px; font-size: 12px; border-radius: 6px; border: 1px solid #22c55e; background: rgba(34,197,94,0.2); color: #22c55e; cursor: pointer; transition: background 0.2s; }
      .kali-window-body .btn-exec:hover { background: rgba(34,197,94,0.4); }
      .kali-window.kali-window--minimized .kali-window-body { display: none; }
      .kali-window.kali-window--minimized .kali-window-resize { display: none; }
      /* 类聊天软件气泡样式 */
      .chat-row { display: flex; margin-bottom: 10px; }
      .chat-row.user { justify-content: flex-end; }
      .chat-row.youkai { justify-content: flex-start; }
      .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 12px; line-height: 1.4; word-break: break-word; white-space: pre-wrap; }
      .chat-row.user .chat-bubble { background: rgba(232,121,249,0.25); border: 1px solid rgba(232,121,249,0.4); color: #e879f9; border-bottom-right-radius: 4px; }
      .chat-row.youkai .chat-bubble { background: rgba(167,139,250,0.2); border: 1px solid rgba(167,139,250,0.35); color: #a78bfa; border-bottom-left-radius: 4px; }
      .chat-bubble .chat-label { font-size: 10px; opacity: 0.8; margin-bottom: 4px; }
      #chat-messages { font-family: system-ui, -apple-system, sans-serif; }
      .chat-confirm-block { margin-top: 8px; }
      .chat-confirm-block input { width: 100%; margin-bottom: 6px; padding: 6px 8px; border-radius: 4px; border: 1px solid #475569; background: rgba(15,23,42,0.9); color: #e2e8f0; font-size: 11px; }
      .chat-confirm-block button { padding: 6px 12px; border-radius: 4px; border: 1px solid #22c55e; background: rgba(34,197,94,0.2); color: #22c55e; font-size: 11px; cursor: pointer; }
      .chat-confirm-block button:hover { background: rgba(34,197,94,0.35); }
      .kali-window-body { flex: 1; overflow: auto; padding: 8px; font-size: 11px; font-family: monospace; color: #a6adc8; }
      .kali-window-body pre { margin: 0; white-space: pre-wrap; word-break: break-all; }
      .kali-window-resize {
        position: absolute;
        right: 0;
        bottom: 0;
        width: 16px;
        height: 16px;
        cursor: nwse-resize;
        background: linear-gradient(135deg, transparent 50%, #45475a 50%);
      }
      .summary-card { background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,100,0.2); border-radius: 6px; padding: 8px; font-size: 11px; color: #94a3b8; white-space: pre-wrap; }
      /* 甲方-黑客对话主窗口：居中下、高亮黄框 */
      .kali-window--chat { border: 2px solid #eab308; box-shadow: 0 0 20px rgba(234,179,8,0.4); }
      .kali-window--chat .kali-window-title { background: linear-gradient(90deg, #313244 0%, rgba(234,179,8,0.15) 100%); border-bottom-color: rgba(234,179,8,0.5); }
      .terminal-live { font-size: 9px; color: #22c55e; margin-left: 6px; animation: live-blink 1.5s ease-in-out infinite; }
      .terminal-live.off { opacity: 0.4; animation: none; }
      @keyframes live-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
      .terminal-follow-wrap { position: relative; }
      .btn-follow-bottom { position: absolute; bottom: 8px; right: 8px; font-size: 10px; padding: 4px 8px; border-radius: 4px; border: 1px solid #22c55e; background: rgba(34,197,94,0.2); color: #22c55e; cursor: pointer; display: none; z-index: 2; }
      .btn-follow-bottom.visible { display: block; }
      #command-submit.loading { pointer-events: none; opacity: 0.85; animation: btn-pulse 1s ease-in-out infinite; }
      @keyframes btn-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(232,121,249,0.4); } 50% { box-shadow: 0 0 12px 4px rgba(232,121,249,0.2); } }
    </style>
  </head>
  <body class="zzz-bg min-h-screen text-slate-100 font-sans antialiased">
    <div id="dot-matrix-bg"><canvas id="dot-canvas"></canvas></div>
    <div class="main-wrap min-h-screen flex flex-col">
      <header class="border-b border-slate-800 flex-shrink-0" style="background: rgba(10,10,15,0.95);">
        <div class="max-w-7xl mx-auto px-4 py-2 flex flex-col gap-2">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div class="flex items-center gap-3">
              <div class="youkai-logo">
                <svg width="36" height="36" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="28" fill="url(#mg)" opacity="0.9"/><circle cx="32" cy="32" r="12" fill="rgba(255,255,255,0.9)"/><defs><linearGradient id="mg" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#e879f9"/><stop offset="1" stop-color="#d946ef"/></linearGradient></defs></svg>
              </div>
              <span class="font-bold text-white">YOUKAI</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="task-strip" id="task-strip" style="display: none;">
                <span class="task-step" data-step="START">START</span>
                <span class="task-step" data-step="RECON">RECON</span>
                <span class="task-step" data-step="ANALYSIS">ANALYSIS</span>
                <span class="task-step" data-step="DECISION">DECISION</span>
                <span class="task-step" data-step="HUMAN_CHECK">HUMAN_CHECK</span>
                <div class="matrix-progress"><div class="matrix-progress-fill" id="matrix-progress-fill"></div></div>
              </div>
              <div class="panel-launcher" id="panel-launcher">
                <button type="button" data-show="chat" title="对话">对话</button>
              <button type="button" data-show="terminal-recon" title="侦察">侦察</button>
              <button type="button" data-show="terminal-analysis" title="分析">分析</button>
              <button type="button" data-show="terminal-exec" title="执行">执行</button>
              <button type="button" data-show="terminal" title="总览">总览</button>
                <button type="button" data-show="report" title="报告">报告</button>
                <button type="button" data-show="ports" title="端口">端口</button>
                <button type="button" data-show="local" title="本机">本机</button>
                <button type="button" data-show="target" title="目标">目标</button>
                <button type="button" data-show="tracking" title="跟踪">跟踪</button>
                <button type="button" data-show="tools" title="Kali 工具">工具</button>
              </div>
              <a href="/settings" class="text-xs text-slate-400 hover:text-fuchsia-400 px-2 py-1 rounded border border-slate-600">设置</a>
            </div>
          </div>
          <div class="flex items-center gap-4 flex-wrap" id="summary-row" style="display: none;">
            <div class="summary-card flex-1 min-w-0" id="summary-card">—</div>
            <div class="flex-shrink-0" style="width: 80px; height: 80px;"><canvas id="port-pie-chart"></canvas></div>
          </div>
        </div>
      </header>

      {% if need_settings %}
      <div class="max-w-7xl mx-auto w-full px-4 py-2">
        <div class="rounded border border-amber-500/40 bg-amber-500/10 px-3 py-2 text-sm text-amber-200 flex justify-between items-center">
          <span>请先在「设置」中配置 LLM API Key</span>
          <a href="/settings" class="text-amber-300 font-medium">去设置</a>
        </div>
      </div>
      {% endif %}

      <!-- 桌面：对话窗口默认显示，其余按需弹出；窗口带 关闭/最小化/最大化 -->
      <div id="desktop" class="flex-1 relative overflow-hidden" style="min-height: 400px;">
        <!-- 甲方-黑客对话主窗口：居中下、稍大、高亮黄框，明确任务目标 / 实时汇报 / 完成后汇报 -->
        <div class="kali-window kali-window--chat" id="win-chat" style="left: 50%; top: auto; bottom: 16px; width: 520px; height: 300px; transform: translateX(-50%);" data-window="chat">
          <div class="kali-window-title">
            <span class="btn btn-close" title="关闭"></span><span class="btn btn-min" title="最小化"></span><span class="btn btn-max" title="最大化"></span>
            <span class="name">任务下达 — 与 Youkai 对话（明确目标 · 过程实时汇报 · 完成后汇报）</span>
          </div>
          <div class="kali-window-body flex flex-col p-2">
            <div id="chat-messages" class="flex-1 overflow-auto mb-2 min-h-0 text-xs space-y-1"></div>
            <form id="command-form" class="flex gap-2 flex-shrink-0">
              <input type="text" id="command-input" placeholder="下达任务目标，如：获取 flag{...}、攻克 CVE-2021-41277 靶标、扫描并渗透某 URL…" class="flex-1 rounded border border-slate-600 bg-slate-900/80 px-2 py-1.5 text-sm text-white placeholder-slate-500 focus:border-fuchsia-500 focus:outline-none" autocomplete="off" />
              <button type="submit" id="command-submit" class="rounded bg-fuchsia-600 hover:bg-fuchsia-500 px-3 py-1.5 text-sm font-medium text-white">发送</button>
            </form>
          </div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-local" style="left: 24px; top: 24px; width: 260px; height: 160px;" data-window="local">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">本机性能</span></div>
          <div class="kali-window-body"><pre id="panel-local-content">—</pre></div>
          <div class="kali-window-resize" title="拖动调整大小"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-target" style="left: 52px; top: 48px; width: 260px; height: 160px;" data-window="target">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">目标情况</span></div>
          <div class="kali-window-body"><pre id="panel-target-content">—</pre></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-ports" style="left: 80px; top: 72px; width: 260px; height: 160px;" data-window="ports">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">目标端口</span></div>
          <div class="kali-window-body"><pre id="panel-ports-content">—</pre></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-tracking" style="left: 108px; top: 96px; width: 260px; height: 140px;" data-window="tracking">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">实施跟踪</span></div>
          <div class="kali-window-body"><pre id="panel-tracking-content">—</pre></div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-report" style="left: 136px; top: 120px; width: 500px; height: 200px;" data-window="report">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">Youkai 报告</span></div>
          <div class="kali-window-body"><div id="panel-report-content">—</div></div>
          <div class="kali-window-resize"></div>
        </div>
        <!-- 多终端：侦察 / 分析 / 执行 / 总览（流式输出 + 实时跟踪） -->
        <div class="kali-window kali-window--hidden" id="win-terminal-recon" style="left: 192px; top: 168px; width: 320px; height: 180px;" data-window="terminal-recon">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">终端 — 侦察</span><span class="terminal-live" id="live-recon">● 实时</span></div>
          <div class="kali-window-body p-2 overflow-auto bg-black/50 min-h-0 terminal-follow-wrap">
            <pre id="terminal-recon-output" class="m-0 text-xs"></pre>
            <button type="button" class="btn-follow-bottom" data-target="terminal-recon-output">回到底部</button>
          </div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-terminal-analysis" style="left: 220px; top: 192px; width: 320px; height: 180px;" data-window="terminal-analysis">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">终端 — 分析</span><span class="terminal-live" id="live-analysis">● 实时</span></div>
          <div class="kali-window-body p-2 overflow-auto bg-black/50 min-h-0 terminal-follow-wrap">
            <pre id="terminal-analysis-output" class="m-0 text-xs"></pre>
            <button type="button" class="btn-follow-bottom" data-target="terminal-analysis-output">回到底部</button>
          </div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-terminal-exec" style="left: 248px; top: 216px; width: 320px; height: 180px;" data-window="terminal-exec">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">终端 — 执行</span><span class="terminal-live" id="live-exec">● 实时</span></div>
          <div class="kali-window-body p-2 overflow-auto bg-black/50 min-h-0 terminal-follow-wrap">
            <pre id="terminal-exec-output" class="m-0 text-xs"></pre>
            <button type="button" class="btn-follow-bottom" data-target="terminal-exec-output">回到底部</button>
          </div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-terminal" style="left: 276px; top: 240px; width: 560px; height: 200px;" data-window="terminal">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">终端 — 总览</span><span class="terminal-live" id="live-general">● 实时</span></div>
          <div class="kali-window-body p-2 overflow-auto bg-black/50 min-h-0 flex-1 terminal-follow-wrap">
            <pre id="terminal-output" class="m-0 text-xs"><span class="term-info">等待指令…</span></pre>
            <button type="button" class="btn-follow-bottom" data-target="terminal-output">回到底部</button>
          </div>
          <div class="kali-window-resize"></div>
        </div>
        <div class="kali-window kali-window--hidden" id="win-tools" style="left: 304px; top: 264px; width: 320px; height: 380px;" data-window="tools">
          <div class="kali-window-title"><span class="btn btn-close"></span><span class="btn btn-min"></span><span class="btn btn-max"></span><span class="name">Kali 工具</span></div>
          <div class="kali-window-body overflow-auto" id="tools-list">
            <p class="text-slate-500 text-xs mb-2">加载中…</p>
          </div>
          <div class="kali-window-resize"></div>
        </div>
      </div>

      <footer class="flex-shrink-0 border-t border-slate-800 px-4 py-2 text-xs text-slate-500" style="background: rgba(10,10,15,0.95);">
        YOUKAI — 甲方在下方对话窗口明确任务目标（如 Flag、靶标），Youkai 自主决策、过程实时汇报、完成后汇报；确认执行渗透在对话内填写 URL 并点击确认。
      </footer>
    </div>

    <script>
      (function() {
        var desktop = document.getElementById('desktop');
        var zIndex = 10;

        function bringFront(win) {
          win.style.zIndex = ++zIndex;
        }

        function makeDraggable(win) {
          var title = win.querySelector('.kali-window-title');
          if (!title) return;
          title.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('btn') || e.target.classList.contains('btn-exec')) return;
            bringFront(win);
            var dx = e.clientX - win.offsetLeft;
            var dy = e.clientY - win.offsetTop;
            function move(e2) {
              win.style.transform = '';
              win.style.bottom = 'auto';
              var l = e2.clientX - dx;
              var t = e2.clientY - dy;
              var r = desktop.getBoundingClientRect();
              win.style.left = Math.max(0, Math.min(l, r.width - 50)) + 'px';
              win.style.top = Math.max(0, Math.min(t, r.height - 40)) + 'px';
            }
            function stop() {
              document.removeEventListener('mousemove', move);
              document.removeEventListener('mouseup', stop);
            }
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', stop);
          });
        }

        function makeResizable(win) {
          var resize = win.querySelector('.kali-window-resize');
          if (!resize) return;
          resize.addEventListener('mousedown', function(e) {
            e.preventDefault();
            bringFront(win);
            var startW = win.offsetWidth;
            var startH = win.offsetHeight;
            var startX = e.clientX;
            var startY = e.clientY;
            function resizeMove(e2) {
              var dw = e2.clientX - startX;
              var dh = e2.clientY - startY;
              win.style.width = Math.max(200, startW + dw) + 'px';
              win.style.height = Math.max(100, startH + dh) + 'px';
            }
            function stop() {
              document.removeEventListener('mousemove', resizeMove);
              document.removeEventListener('mouseup', stop);
            }
            document.addEventListener('mousemove', resizeMove);
            document.addEventListener('mouseup', stop);
          });
        }

        function wireWindowButtons(win) {
          var closeBtn = win.querySelector('.btn-close');
          var minBtn = win.querySelector('.btn-min');
          var maxBtn = win.querySelector('.btn-max');
          if (closeBtn) closeBtn.addEventListener('click', function(e) { e.stopPropagation(); win.classList.add('kali-window--hidden'); });
          if (minBtn) minBtn.addEventListener('click', function(e) { e.stopPropagation(); win.classList.toggle('kali-window--minimized'); });
          if (maxBtn) maxBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (win.classList.contains('kali-window--maximized')) { win.classList.remove('kali-window--maximized'); win.style.width = ''; win.style.height = ''; }
            else {
              win.style.transform = '';
              win.style.bottom = 'auto';
              win.classList.add('kali-window--maximized'); win.style.width = '90%'; win.style.height = '80%'; win.style.left = '5%'; win.style.top = '5%';
            }
          });
        }
        desktop.querySelectorAll('.kali-window').forEach(function(win) {
          makeDraggable(win);
          makeResizable(win);
          wireWindowButtons(win);
        });
      })();

      window.YoukaiUI = {
        TASK_ORDER: ['START', 'RECON', 'ANALYSIS', 'DECISION', 'HUMAN_CHECK'],
        showWindow: function(id) {
          var w = document.getElementById('win-' + id);
          if (w) w.classList.remove('kali-window--hidden');
        },
        hideWindow: function(id) {
          var w = document.getElementById('win-' + id);
          if (w) w.classList.add('kali-window--hidden');
        },
        setTaskProgress: function(step) {
          var strip = document.getElementById('task-strip');
          var fill = document.getElementById('matrix-progress-fill');
          if (!strip || !fill) return;
          strip.style.display = 'flex';
          var order = this.TASK_ORDER;
          var idx = order.indexOf(step);
          if (idx === -1) idx = 0;
          var pct = ((idx + 1) / order.length) * 100;
          fill.style.width = pct + '%';
          strip.querySelectorAll('.task-step').forEach(function(el) {
            var s = el.dataset.step;
            el.classList.remove('active', 'done');
            if (order.indexOf(s) < idx) el.classList.add('done');
            else if (s === step) el.classList.add('active');
          });
        },
        setTaskDone: function() {
          var fill = document.getElementById('matrix-progress-fill');
          if (fill) fill.style.width = '100%';
          document.querySelectorAll('.task-step').forEach(function(el) { el.classList.add('done'); el.classList.remove('active'); });
        },
        showSummary: function(summaryText, portCounts) {
          var row = document.getElementById('summary-row');
          var card = document.getElementById('summary-card');
          if (row) row.style.display = 'flex';
          if (card && summaryText) card.textContent = summaryText;
          if (portCounts && (portCounts.open || portCounts.filtered || portCounts.closed)) {
            this.updatePortChart(portCounts);
          }
        },
        portChart: null,
        updatePortChart: function(counts) {
          var canvas = document.getElementById('port-pie-chart');
          if (!canvas) return;
          var open = counts.open || 0, filtered = counts.filtered || 0, closed = counts.closed || 0;
          if (open + filtered + closed === 0) return;
          if (window.YoukaiUI.portChart) window.YoukaiUI.portChart.destroy();
          window.YoukaiUI.portChart = new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['开放', '过滤', '关闭'],
              datasets: [{ data: [open, filtered, closed], backgroundColor: ['#22c55e', '#eab308', '#64748b'], borderColor: '#1e1e2e', borderWidth: 2 }]
            },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10 } } } } }
          });
        },
        markLauncherHasContent: function(ids) {
          document.querySelectorAll('#panel-launcher button').forEach(function(btn) {
            var id = btn.dataset.show;
            btn.classList.toggle('has-content', ids && ids.indexOf(id) !== -1);
          });
        },
        WINDOW_ORDER: ['chat','local','target','ports','tracking','report','terminal-recon','terminal-analysis','terminal-exec','terminal','tools'],
        layoutWindowsUniform: function() {
          var desktop = document.getElementById('desktop');
          if (!desktop) return;
          var rect = desktop.getBoundingClientRect();
          var w = rect.width || 1200;
          var h = rect.height || 600;
          var cols = 4;
          var gap = 10;
          var cellW = Math.max(220, Math.floor((w - gap * (cols + 1)) / cols));
          var rows = Math.ceil(12 / cols);
          var cellH = Math.max(140, Math.floor((h - gap * (rows + 1)) / rows));
          var visible = [];
          this.WINDOW_ORDER.forEach(function(id) {
            var win = document.getElementById('win-' + id);
            if (win && !win.classList.contains('kali-window--hidden')) visible.push(win);
          });
          visible.forEach(function(win, i) {
            var c = i % cols;
            var r = Math.floor(i / cols);
            win.style.left = (gap + c * (cellW + gap)) + 'px';
            win.style.top = (gap + r * (cellH + gap)) + 'px';
            win.style.width = cellW + 'px';
            win.style.height = cellH + 'px';
          });
        }
      };

      (function dotMatrixBg() {
        var canvas = document.getElementById('dot-canvas');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        var dots = [];
        var cols = 48;
        var rows = 28;
        function resize() {
          canvas.width = canvas.offsetWidth;
          canvas.height = canvas.offsetHeight;
          dots = [];
          var stepX = canvas.width / (cols + 1);
          var stepY = canvas.height / (rows + 1);
          for (var r = 0; r < rows; r++) {
            for (var c = 0; c < cols; c++) {
              dots.push({ x: stepX * (c + 1) + (Math.random() - 0.5) * stepX * 0.3, y: stepY * (r + 1) + (Math.random() - 0.5) * stepY * 0.3, r: 0.8 + Math.random() * 0.6, phase: Math.random() * Math.PI * 2 });
            }
          }
          draw();
        }
        function draw() {
          if (!ctx || !canvas.width) return;
          ctx.fillStyle = 'rgba(10,10,15,0.92)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          var t = Date.now() / 1200;
          ctx.fillStyle = 'rgba(0,255,100,0.5)';
          dots.forEach(function(d) {
            var glow = 0.4 + 0.3 * Math.sin(t + d.phase);
            ctx.globalAlpha = glow;
            ctx.beginPath();
            ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
            ctx.fill();
          });
          ctx.globalAlpha = 1;
          requestAnimationFrame(draw);
        }
        resize();
        window.addEventListener('resize', resize);
      })();

      var form = document.getElementById('command-form');
      var input = document.getElementById('command-input');
      var submitBtn = document.getElementById('command-submit');
      var terminal = document.getElementById('terminal-output');
      var chatMessages = document.getElementById('chat-messages');

      function appendChatMessage(who, text) {
        if (!chatMessages) return;
        var row = document.createElement('div');
        row.className = 'chat-row ' + (who === 'user' ? 'user' : 'youkai');
        var bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        var label = document.createElement('div');
        label.className = 'chat-label';
        label.textContent = who === 'user' ? '我' : 'Youkai';
        bubble.appendChild(label);
        var content = document.createElement('div');
        content.textContent = text;
        bubble.appendChild(content);
        row.appendChild(bubble);
        chatMessages.appendChild(row);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function appendConfirmInChat() {
        if (!chatMessages) return;
        var row = document.createElement('div');
        row.className = 'chat-row youkai';
        var bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        var label = document.createElement('div');
        label.className = 'chat-label';
        label.textContent = 'Youkai';
        bubble.appendChild(label);
        var text = document.createElement('div');
        text.textContent = '若需执行渗透，请填写目标 URL 并点击下方确认执行：';
        bubble.appendChild(text);
        var block = document.createElement('div');
        block.className = 'chat-confirm-block';
        var inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'chat-exploit-url';
        inp.placeholder = 'http://target/page?id=1';
        block.appendChild(inp);
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chat-confirm-exec-btn';
        btn.textContent = '确认执行 (sqlmap)';
        block.appendChild(btn);
        bubble.appendChild(block);
        row.appendChild(bubble);
        chatMessages.appendChild(row);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      var channelToId = { recon: 'terminal-recon-output', analysis: 'terminal-analysis-output', exec: 'terminal-exec-output', general: 'terminal-output' };
      function stepToChannel(step) {
        if (!step) return 'general';
        if (step === 'RECON') return 'recon';
        if (step === 'ANALYSIS') return 'analysis';
        if (step === 'DECISION' || step === 'HUMAN_CHECK') return 'exec';
        return 'general';
      }
      function appendDebug(step, message) {
        var ch = stepToChannel(step);
        var text = '[DEBUG] ' + (step || '') + ' — ' + (message || '');
        appendTerminalSingle({ type: 'info', text: text, channel: ch });
        if (ch !== 'general') appendTerminalSingle({ type: 'info', text: text, channel: 'general' });
      }
      function getTerminalScrollContainer(preEl) {
        var wrap = preEl && preEl.parentElement;
        return wrap && wrap.classList && wrap.classList.contains('terminal-follow-wrap') ? wrap.parentElement : (preEl && preEl.parentElement);
      }
      function scrollTerminalToBottom(preEl) {
        var container = getTerminalScrollContainer(preEl);
        if (container) container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        var btn = preEl && preEl.parentElement && preEl.parentElement.querySelector('.btn-follow-bottom');
        if (btn) btn.classList.remove('visible');
      }
      function setupTerminalFollow(preId) {
        var preEl = document.getElementById(preId);
        if (!preEl) return;
        var container = getTerminalScrollContainer(preEl);
        var btn = preEl.parentElement && preEl.parentElement.querySelector('.btn-follow-bottom');
        if (!container || !btn) return;
        container.addEventListener('scroll', function() {
          var atBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 20;
          btn.classList.toggle('visible', !atBottom);
        });
        btn.addEventListener('click', function() {
          container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
          btn.classList.remove('visible');
        });
      }
      ['terminal-recon-output','terminal-analysis-output','terminal-exec-output','terminal-output'].forEach(setupTerminalFollow);

      function appendTerminal(lines) {
        if (!lines || !lines.length) return;
        lines.forEach(function(line) {
          var channel = line.channel || 'general';
          var el = document.getElementById(channelToId[channel]);
          if (!el) el = terminal;
          var span = document.createElement('span');
          span.className = 'term-' + (line.type || 'info');
          span.textContent = line.text + '\n';
          el.appendChild(span);
          scrollTerminalToBottom(el);
        });
        if (terminal && terminal.parentNode) scrollTerminalToBottom(terminal);
      }
      function appendTerminalSingle(line) {
        appendTerminal([line]);
      }

      document.getElementById('panel-launcher').addEventListener('click', function(e) {
        var id = e.target.dataset && e.target.dataset.show;
        if (id) window.YoukaiUI.showWindow(id);
      });

      function setPanel(id, text) {
        var el = document.getElementById('panel-' + id + '-content');
        if (!el) return;
        if (id === 'report' && typeof marked !== 'undefined') {
          try { el.innerHTML = marked.parse(text || '—'); } catch (e) { el.textContent = text || '—'; }
        } else {
          el.textContent = text || '—';
        }
      }

      function setPanels(panels) {
        if (!panels) return;
        var ls = panels.local_stats;
        if (ls) setPanel('local', 'CPU: ' + (ls.cpu_percent ?? 0) + '%\n内存: ' + (ls.mem_percent ?? 0) + '% (' + (ls.mem_used_gb ?? 0) + '/' + (ls.mem_total_gb ?? 0) + ' GB)');
        var ti = panels.target_info;
        if (ti) setPanel('target', 'Goal: ' + (ti.goal || '') + '\nTarget: ' + (ti.target || ''));
        setPanel('ports', panels.ports);
        setPanel('tracking', panels.tracking);
        setPanel('report', panels.report);
        window.YoukaiUI.setTaskDone();
        var summary = panels.report_summary || panels.report || '';
        if (summary && summary.length > 500) summary = summary.slice(0, 500) + '…';
        window.YoukaiUI.showSummary(summary, panels.port_counts);
        var withContent = [];
        if (ls) withContent.push('local');
        if (ti) withContent.push('target');
        if (panels.ports && panels.ports !== '暂无') withContent.push('ports');
        if (panels.tracking) withContent.push('tracking');
        if (panels.report && panels.report !== '暂无报告') withContent.push('report');
        withContent.push('terminal', 'terminal-recon', 'terminal-analysis', 'terminal-exec');
        window.YoukaiUI.markLauncherHasContent(withContent);
        withContent.forEach(function(id) { window.YoukaiUI.showWindow(id); });
      }

      chatMessages.addEventListener('click', async function(e) {
        var btn = e.target && e.target.classList && e.target.classList.contains('chat-confirm-exec-btn') ? e.target : null;
        if (!btn) return;
        var block = btn.closest('.chat-confirm-block');
        var inp = block && block.querySelector('.chat-exploit-url');
        var url = (inp && inp.value && inp.value.trim()) ? inp.value.trim() : '';
        if (!url) { appendChatMessage('youkai', '请先在上方框内填写利用 URL 再点击确认执行。'); return; }
        btn.disabled = true;
        window.YoukaiUI.showWindow('terminal-exec');
        var execOut = document.getElementById('terminal-exec-output');
        if (execOut) execOut.innerHTML = '';
        appendTerminal([{ type: 'cmd', text: '[EXPLOIT] sqlmap -u ' + url, channel: 'exec' }]);
        try {
          var res = await fetch('/api/execute_exploit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'sqlmap', payload: { url: url } }) });
          var data = await res.json();
          if (data.terminal && data.terminal.length) {
            data.terminal.forEach(function(l) { l.channel = 'exec'; });
            appendTerminal(data.terminal);
          }
          if (!data.ok) appendTerminal([{ type: 'error', text: data.error || '执行失败', channel: 'exec' }]);
          appendChatMessage('youkai', data.ok ? '已执行 sqlmap，请查看「终端 — 执行」。' : ('执行失败：' + (data.error || '')));
        } catch (err) {
          appendTerminal([{ type: 'error', text: err.message, channel: 'exec' }]);
          appendChatMessage('youkai', '网络错误：' + (err.message || ''));
        }
        btn.disabled = false;
      });

      function readStreamNDJSON(res, onLine) {
        var reader = res.body.getReader();
        var decoder = new TextDecoder();
        var buf = '';
        function pump() {
          return reader.read().then(function(chunk) {
            if (chunk.done) return;
            buf += decoder.decode(chunk.value, { stream: true });
            var lines = buf.split('\n');
            buf = lines.pop() || '';
            lines.forEach(function(line) {
              line = line.trim();
              if (!line) return;
              try {
                var data = JSON.parse(line);
                onLine(data);
              } catch (e) {}
            });
            return pump();
          });
        }
        return pump();
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        var msg = (input.value || '').trim();
        if (!msg) return;
        appendChatMessage('user', msg);
        submitBtn.disabled = true;
        ['terminal-recon-output','terminal-analysis-output','terminal-exec-output','terminal-output'].forEach(function(id) {
          var el = document.getElementById(id);
          if (el) el.innerHTML = '';
        });
        window.YoukaiUI.showWindow('terminal');
        window.YoukaiUI.showWindow('terminal-recon');
        window.YoukaiUI.showWindow('terminal-analysis');
        window.YoukaiUI.showWindow('terminal-exec');
        window.YoukaiUI.setTaskProgress('START');
        try {
          var res = await fetch('/api/command_stream', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msg }) });
          if (!res.ok) {
            appendChatMessage('youkai', '请求失败：' + res.status);
            submitBtn.disabled = false;
            submitBtn.classList.remove('loading');
            return;
          }
          await readStreamNDJSON(res, function(data) {
            if (data.type === 'reply') {
              appendChatMessage('youkai', data.message || '收到。');
              appendDebug('START', 'reply: ' + (data.message || ''));
            } else if (data.type === 'progress') {
              var ch = data.channel || 'recon';
              appendTerminalSingle({ type: 'info', text: data.line || '', channel: ch });
              if (ch !== 'general') appendTerminalSingle({ type: 'info', text: data.line || '', channel: 'general' });
            } else if (data.type === 'thinking') {
              window.YoukaiUI.setTaskProgress(data.step || 'START');
              appendDebug(data.step, data.message || '');
              appendTerminalSingle({ type: 'thinking', text: '[Thinking] ' + (data.step || '') + ' — ' + (data.message || ''), channel: 'general' });
            } else if (data.type === 'terminal_line' && data.line) {
              appendTerminal([data.line]);
            } else if (data.type === 'done' && data.ok) {
              appendDebug('HUMAN_CHECK', 'done');
              if (data.panels) setPanels(data.panels);
              appendChatMessage('youkai', '分析完成，请查看报告与终端。');
              appendConfirmInChat();
            } else if (data.type === 'error') {
              appendChatMessage('youkai', '错误：' + (data.message || '未知'));
              appendTerminalSingle({ type: 'error', text: data.message || '错误', channel: 'general' });
            }
          });
        } catch (err) {
          var errMsg = err && (err.message || String(err));
          if (!errMsg || errMsg === 'Failed to fetch' || /network error/i.test(errMsg)) errMsg = '网络连接异常，请确认服务已启动且可访问，或稍后重试。';
          appendChatMessage('youkai', '错误：' + errMsg);
          appendTerminalSingle({ type: 'error', text: '[ERROR] ' + errMsg, channel: 'general' });
          submitBtn.disabled = false;
          submitBtn.classList.remove('loading');
          return;
        }
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
      });
      form.addEventListener('submit', function() { if ((input.value || '').trim()) submitBtn.classList.add('loading'); });

      // Kali 工具列表与运行
      fetch('/api/tools').then(function(r) { return r.json(); }).then(function(data) {
        var list = document.getElementById('tools-list');
        if (!data.tools || !data.tools.length) { list.innerHTML = '<p class="text-slate-500 text-xs">无工具</p>'; return; }
        list.innerHTML = '';
        data.tools.forEach(function(t) {
          var div = document.createElement('div');
          div.className = 'border border-slate-600 rounded p-2 mb-2';
          div.innerHTML = '<div class="text-fuchsia-400 font-medium text-xs">' + t.name + '</div><div class="text-slate-500 text-[10px] mb-1">' + (t.desc || '') + '</div>';
          var params = (t.params || []);
          var inputs = {};
          params.forEach(function(p) {
            var inp = document.createElement('input');
            inp.placeholder = p.placeholder || p.key;
            inp.className = 'w-full rounded border border-slate-600 bg-slate-800/80 px-1.5 py-0.5 text-xs text-white mb-1';
            inp.dataset.key = p.key;
            inputs[p.key] = inp;
            div.appendChild(inp);
          });
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'mt-1 rounded bg-slate-600 hover:bg-slate-500 text-xs px-2 py-0.5';
          btn.textContent = '运行';
          btn.addEventListener('click', function() {
            var paramsObj = {};
            params.forEach(function(p) { paramsObj[p.key] = (inputs[p.key] && inputs[p.key].value) || ''; });
            terminal.innerHTML = '';
            appendTerminal([{ type: 'cmd', text: '[Kali] ' + t.id + ' ' + JSON.stringify(paramsObj) }]);
            fetch('/api/tool', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tool: t.id, params: paramsObj }) })
              .then(function(r) { return r.json(); })
              .then(function(d) {
                if (d.terminal && d.terminal.length) appendTerminal(d.terminal);
                if (!d.ok) appendTerminal([{ type: 'error', text: d.error || '执行失败' }]);
              })
              .catch(function(err) { appendTerminal([{ type: 'error', text: err.message }]); });
          });
          div.appendChild(btn);
          list.appendChild(div);
        });
      }).catch(function() {
        document.getElementById('tools-list').innerHTML = '<p class="text-slate-500 text-xs">加载工具列表失败</p>';
      });
    </script>
  </body>
</html>
