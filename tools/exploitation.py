"""利用类工具：sqlmap、自定义高危命令，需人工确认后执行。"""

from __future__ import annotations

import shlex
import subprocess
from typing import Optional

from langchain_core.tools import tool

from tools.base import ToolMetadata


HIGH_RISK_METADATA = ToolMetadata(
    name="exploitation",
    description="高危利用动作封装，需要人工审批后执行。",
    dangerous=True,
    human_approval_required=True,
)


@tool("placeholder_exploit", return_direct=False)
def placeholder_exploit(description: str) -> str:
    """占位 Tool：仅用于演示高危操作需要人工审批的设计。"""
    return (
        "[HUMAN_CHECK_REQUIRED] 收到潜在利用请求，但 exploitation 工具尚未实现。\n"
        "请在人工确认后，再补充具体的利用逻辑与调用参数：\n"
        f"- 描述: {description}"
    )


def run_sqlmap(url: str, extra_args: str = "--batch --level=1 --risk=1", timeout: int = 300) -> tuple[int, str, str]:
    """在本机执行 sqlmap（需已安装 sqlmap）。返回 (returncode, stdout, stderr)。"""
    if not url or not url.strip():
        return -1, "", "URL 不能为空"
    args = ["sqlmap", "-u", url.strip()]
    args.extend(shlex.split(extra_args or "--batch --level=1 --risk=1"))
    try:
        proc = subprocess.run(
            args,
            capture_output=True,
            text=True,
            timeout=timeout,
        )
        return proc.returncode, proc.stdout or "", proc.stderr or ""
    except FileNotFoundError:
        return -1, "", "未找到 sqlmap，请确保已安装（apt install sqlmap 或 pip install sqlmap）"
    except subprocess.TimeoutExpired:
        return -1, "", f"sqlmap 执行超时（{timeout}s）"
    except Exception as e:  # noqa: BLE001
        return -1, "", str(e)


def run_dangerous_command(allowed_action: str, payload: dict) -> tuple[int, str, str]:
    """仅允许白名单内的利用动作。allowed_action: sqlmap。"""
    if allowed_action == "sqlmap":
        url = payload.get("url") or ""
        extra = payload.get("extra_args") or "--batch --level=1 --risk=1"
        return run_sqlmap(url, extra)
    return -1, "", f"不允许的执行类型: {allowed_action}"


__all__ = ["HIGH_RISK_METADATA", "placeholder_exploit", "run_sqlmap", "run_dangerous_command"]
